<!DOCTYPE html>
<html lang="id">
<head>
  <!-- Meta, CSS, dan Library sama persis dengan index.html -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create SI - ATL Energy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Library untuk QR Code dan Barcode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* Styles sama persis dengan index.html */
    :root {
      --primary-color: #0A4D68;
      --secondary-color: #088395;
      --accent-color: #F5A31A;
      --light-bg: #F8F9FA;
      --dark-text: #212529;
      --light-text: #FFFFFF;
      --border-radius-md: 0.5rem;
      --border-radius-lg: 0.75rem;
    }

    /* ... (CSS sama dengan index.html) ... */

    /* Tambahan styling untuk QR & Barcode */
    .code-container {
      display: flex;
      justify-content: center;
      gap: 3rem;
      margin: 2rem 0;
      flex-wrap: wrap;
    }
    
    .code-wrapper {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: var(--border-radius-md);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 1rem 0;
    }

    .code-label {
      margin-top: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
<!-- Navbar sama dengan index.html tapi link active di Create SI -->
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-ship"></i> Tracking Bungker</a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/index.html">Beranda</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Kontak Kami</a></li>
        <li class="nav-item"><a class="nav-link active" href="/barcode-qr.html">Create SI</a></li>
        <li class="nav-item"><a class="nav-link" href="/update-status.html">Update Status</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container pb-5">
  <div class="card-form">
    <div class="logo-container">
      <img src="LOGO ATL_1024X1024.jpeg" alt="ATL Energy Logo" style="max-width: 160px;">
    </div>

    <hr class="custom-line">

    <div class="form-section">
      <form id="trackerForm" class="d-flex gap-3 flex-column flex-md-row mb-3">
        <input type="text" id="transaction_no" class="form-control form-control-lg" placeholder="Masukkan No Transaksi Anda" required />
        <button type="submit" class="btn btn-primary btn-lg px-4"><i class="fas fa-file-alt"></i> Create SI</button>
      </form>

      <div class="action-buttons-container">
        <button id="exportPdfBtn" class="btn btn-success btn-sm d-none"><i class="fas fa-file-pdf"></i> Export PDF</button>
        <button class="btn btn-danger btn-sm d-none" id="closeResultBtn" onclick="closeResult()"><i class="fas fa-times-circle"></i> Tutup Data</button>
      </div>
      
      <div id="result" class="document">
          </div>
    </div>
  </div>
</div>

<footer class="footer">
    <div class="container">
        <p>&copy; <span id="currentYear"></span> PT. ARIVINDO TECH LESTARI. Hak Cipta Dilindungi.</p>
        <p>Didukung oleh Teknologi Modern untuk Pelacakan Akurat</p>
    </div>
</footer>

<script>
  // Script utama sama dengan index.html dengan tambahan generate QR-Barcode
  const form = document.getElementById('trackerForm');
  const outputDiv = document.getElementById('result');
  const closeBtn = document.getElementById('closeResultBtn');
  const exportBtn = document.getElementById('exportPdfBtn');

  document.getElementById('currentYear').textContent = new Date().getFullYear();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const transaction_no = document.getElementById('transaction_no').value;

    outputDiv.innerHTML = `<div class="loading-spinner"><div class="spinner-border" role="status"></div></div>`;
    outputDiv.style.display = 'block';
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');

    try {
        const response = await fetch('/track', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transaction_no })
        });

        if (!response.ok) throw new Error('Gagal mengambil data');

        const result = await response.json();
        if (result.success && result.data) {
            const { transaction_no, transaction_date, ship_via, tags, person, transaction_lines_attributes, memo } = result.data;
            const tagText = tags?.[0] || '-';
            const customerName = person?.display_name || '-';
            const statusMemo = memo || '-';

            const itemsHtml = transaction_lines_attributes.map((item, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${item.product.name || '-'}</td>
                    <td>${item.quantity ?? 0}</td>
                </tr>`).join('');
            
            const totalQty = transaction_lines_attributes.reduce((sum, item) => sum + (item.quantity || 0), 0);

            outputDiv.innerHTML = `
                <h5>Dokumen Permintaan Pengapalan Barang Angkutan Laut</h5>
                <h6>SHIPPING INSTRUCTION<br>No. ${transaction_no}</h6>
                
                <!-- Tambahan QR dan Barcode di tengah -->
                <div class="code-container">
                  <div class="code-wrapper">
                    <div id="qrcode"></div>
                    <div class="code-label">QR CODE</div>
                  </div>
                  <div class="code-wrapper">
                    <svg id="barcode"></svg>
                    <div class="code-label">BARCODE</div>
                  </div>
                </div>

                <h6 style="color: ${statusMemo.toLowerCase() === 'selesai bongkar' ? '#dc3545' : '#198754'};">Status: ${statusMemo}</h6>
                <p><strong>Nama Customer:</strong> ${customerName}</p>

                <table class="table table-bordered table-hover">
                    <tr><td>Nama Pemilik/Pengirim Barang</td><td>PT. ARIVINDO TECH LESTARI</td></tr>
                    <tr><td>Alamat Perusahaan</td><td>Dusun 4, Desa Rejo Mulyo RT09, Kec. Tanjung Bintang, Tanjung Bintang, Kab.Lampung Selatan</td></tr>
                </table>

                <table class="table table-bordered table-hover">
                    <tr><td>Nama Pelayaran Agen</td><td>Rejomulyo</td></tr>
                    <tr><td>Alamat Kantor Pusat</td><td>Gedung Menara 165 Lt 4 , Jalan TB simatupang, Kav 1 Cilandak Timur, Pasar Minggu, Kota Adm Jakarta Selatan</td></tr>
                    <tr><td>Alamat Kantor Cabang</td><td>-</td></tr>
                    <tr><td>Nama Kapal</td><td>${ship_via || '-'}</td></tr>
                    <tr><td>ETD/ETA</td><td>${transaction_date} s/d [ETA]</td></tr>
                    <tr><td>Pelabuhan Muat</td><td>${tagText}</td></tr>
                </table>

                <table class="table table-bordered table-hover">
                    <thead><tr><th>NO</th><th>JENIS BARANG</th><th>JUMLAH (Liter)</th></tr></thead>
                    <tbody>
                        ${itemsHtml}
                        <tr><td colspan="2"><strong>JUMLAH</strong></td><td><strong>${totalQty}</strong></td></tr>
                    </tbody>
                </table>

                <p class="mt-4">Lampung, ...............................................</p>
                <p><strong>Pemilik/Pengirim Barang</strong><br>PT. ARVINDO TECH LESTARI</p>
            `;

            // Generate QR Code
            new QRCode(document.getElementById('qrcode'), {
                text: transaction_no,
                width: 150,
                height: 150,
                colorDark: "#0A4D68"
            });

            // Generate Barcode
            JsBarcode('#barcode', transaction_no, {
                format: 'CODE128',
                displayValue: true,
                fontSize: 16,
                lineColor: "#0A4D68",
                width: 2,
                height: 60
            });

            outputDiv.style.display = 'block';
            closeBtn.classList.remove('d-none');
            exportBtn.classList.remove('d-none');
        } else {
            outputDiv.innerHTML = `<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle me-2"></i>${result.message}</div>`;
            outputDiv.style.display = 'block';
            closeBtn.classList.remove('d-none');
        }
    } catch (error) {
        outputDiv.innerHTML = `<div class="alert alert-danger text-center"><i class="fas fa-times-circle me-2"></i>${error.message}</div>`;
        outputDiv.style.display = 'block';
        closeBtn.classList.remove('d-none');
    }
  });

  // Fungsi closeResult dan exportPDF sama dengan index.html
  function closeResult() {
    outputDiv.style.display = 'none';
    outputDiv.innerHTML = '';
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');
    document.getElementById('transaction_no').value = '';
  }

  document.getElementById('exportPdfBtn').addEventListener('click', () => {
    // Logika export PDF sama dengan index.html
    const element = document.getElementById('result');
    const opt = {
        margin: [0.5, 0.4],
        filename: `SI_${Date.now()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(element).set(opt).save();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
