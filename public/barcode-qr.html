<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tracking Bungker - Buat Barcode/QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Poppins', Arial, sans-serif; /* Ganti font agar lebih modern */
    }
    nav {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Shadow lebih soft */
    }
    .card-form {
      max-width: 800px;
      margin: 2.5rem auto; /* Spasi lebih */
      padding: 2.5rem;
      border-radius: 0.75rem; /* Radius lebih besar */
      box-shadow: 0 8px 25px rgba(0,0,0,0.08); /* Shadow lebih jelas */
      background-color: #ffffff;
      border: none; /* Hilangkan border */
    }
    .document h5 {
      font-family: 'Poppins', sans-serif;
      text-align: center;
      font-size: 1.4rem; /* Sesuaikan ukuran */
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }
    .document h6 {
      font-family: 'Poppins', sans-serif;
      text-align: center;
      font-size: 1.1rem; /* Sesuaikan ukuran */
      font-weight: 500;
      color: #555;
      margin-bottom: 1.5rem;
    }
    .document .table td, .document .table th {
      vertical-align: middle;
      font-size: 0.9rem; /* Ukuran font tabel */
    }
    .document .table th {
        background-color: #f8f9fa; /* Latar header tabel */
    }
    #result {
      display: none;
      margin-top: 2rem; /* Spasi lebih sebelum hasil */
      padding: 1.5rem;
      border: 1px solid #e9ecef;
      border-radius: 0.5rem;
      background-color: #fdfdff;
    }
    hr.custom-line {
      border: 0;
      height: 1px;
      background-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.1), rgba(0,0,0,0));
      margin: 2rem 0;
    }
    .barcode-qr-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin: 2rem auto; /* Pusatkan container */
      padding: 1rem;
      border: 1px dashed #ced4da;
      border-radius: 0.5rem;
      max-width: 300px; /* Batasi lebar agar tidak terlalu besar */
    }
    #barcode {
        max-width: 100%;
        height: auto; /* Agar responsif */
    }
    #qrcode img {
        margin: auto;
        display: block;
    }
    .btn-primary { /* Styling tombol utama */
        background-color: #0A4D68;
        border-color: #0A4D68;
    }
    .btn-primary:hover {
        background-color: #083D56;
        border-color: #083D56;
    }
    .form-control:focus { /* Styling focus input */
        border-color: #0A4D68;
        box-shadow: 0 0 0 0.25rem rgba(10, 77, 104, 0.25);
    }
    /* Tambahkan Font Poppins jika belum ada di halaman lain */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><i class="fas fa-ship me-2"></i>Tracking Bungker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/">Beranda</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/barcode-qr.html">Create SI</a></li>
        <li class="nav-item"><a class="nav-link" href="/update-status.html">Update Status</a></li>
        <li class="nav-item"><a class="nav-link text-danger fw-bold" href="/logout"><i class="fas fa-sign-out-alt me-1"></i>Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container pb-5">
  <div class="card-form">
    <div class="form-section">
      <div class="text-center mb-3">
        <img src="/images/LOGO ATL_1024X1024.jpeg" alt="ATL Energy Logo" style="max-width: 150px;" onerror="this.style.display='none'; console.warn('Logo tidak ditemukan di /images/LOGO ATL_1024X1024.jpeg')">
      </div>
      <h4 class="text-center mb-1 fw-semibold">Buat Shipping Instruction</h4>
      <p class="text-center text-muted mb-4">Masukkan nomor transaksi untuk membuat dokumen.</p>
      <hr class="custom-line">
      <form id="trackerForm" class="mb-3">
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="fas fa-file-invoice"></i></span>
            <input type="text" id="transaction_no" class="form-control form-control-lg" placeholder="Masukkan No Transaksi" required />
            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-cogs me-2"></i>Proses</button>
        </div>
      </form>
      <div class="d-flex justify-content-end gap-2 mb-3">
        <button id="exportPdfBtn" class="btn btn-success d-none"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
        <button class="btn btn-outline-danger btn-sm d-none" id="closeResultBtn" onclick="closeResult()"><i class="fas fa-times me-1"></i>Tutup Data</button>
      </div>
      <div id="result" class="document">
        </div>
    </div>
  </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">Pemberitahuan</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastBody">
      Pesan toast.
    </div>
  </div>
</div>


<script>
  const form = document.getElementById('trackerForm');
  const outputDiv = document.getElementById('result');
  const closeBtn = document.getElementById('closeResultBtn');
  const exportBtn = document.getElementById('exportPdfBtn');
  const transactionNoInput = document.getElementById('transaction_no');
  const alertToastEl = document.getElementById('alertToast');
  const toastTitleEl = document.getElementById('toastTitle');
  const toastBodyEl = document.getElementById('toastBody');
  const toast = new bootstrap.Toast(alertToastEl);

  function showCustomAlert(message, type = 'info', title = 'Pemberitahuan') {
    toastTitleEl.textContent = title;
    toastBodyEl.textContent = message;
    // Hapus kelas bg- sebelumnya
    alertToastEl.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-info', 'text-white');
    
    let bgClass = 'bg-info'; // Default
    if (type === 'success') bgClass = 'bg-success';
    else if (type === 'warning') bgClass = 'bg-warning';
    else if (type === 'danger' || type === 'error') bgClass = 'bg-danger';

    alertToastEl.classList.add(bgClass, 'text-white');
    toast.show();
  }


  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const transaction_no = transactionNoInput.value.trim();

    if (!transaction_no) {
        showCustomAlert('Nomor transaksi tidak boleh kosong.', 'warning', 'Input Tidak Valid');
        outputDiv.innerHTML = `<div class="alert alert-warning">Nomor transaksi tidak boleh kosong.</div>`;
        outputDiv.style.display = 'block';
        closeBtn.classList.add('d-none');
        exportBtn.classList.add('d-none');
        return;
    }

    outputDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <p class="mt-2">Memproses data untuk <strong>${transaction_no}</strong>...</p></div>`;
    outputDiv.style.display = 'block';
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');

    try {
        const response = await fetch('/track', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transaction_no })
        });

        if (!response.ok) {
            let errorMessage = `Gagal mengambil data (Status: ${response.status})`;
            try {
                const errorResult = await response.json();
                errorMessage = errorResult.message || errorMessage;
            } catch (parseError) {
                console.warn("Gagal parse error JSON dari server:", parseError);
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log("Data diterima dari /track:", result);

        if (result.success && result.data) {
          const { transaction_no: res_transaction_no, transaction_date, ship_via, tags, person, transaction_lines_attributes, memo } = result.data;
          
          if (typeof res_transaction_no !== 'string' || !res_transaction_no.trim()) {
            console.error("Nomor transaksi dari server tidak valid:", res_transaction_no);
            showCustomAlert('Data transaksi diterima, tetapi nomor transaksi tidak valid.', 'danger', 'Error Data');
            outputDiv.innerHTML = `<div class="alert alert-danger">Data transaksi diterima, tetapi nomor transaksi tidak valid.</div>`;
            closeBtn.classList.remove('d-none'); // Tampilkan tombol tutup agar pengguna bisa menutup pesan error
            exportBtn.classList.add('d-none');
            return; 
          }

          const tagText = (tags && tags.length > 0) ? tags.map(t => t.name || t).join(', ') : '-';
          const customerName = person?.display_name || person?.name || 'Tidak Ada Nama';

          const itemsHtml = (transaction_lines_attributes || []).map((item, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${item.product?.name || item.name || item.description || 'Tidak Ada Deskripsi'}</td>
              <td>${item.quantity ?? 0}</td>
            </tr>`).join('');
          const totalQty = (transaction_lines_attributes || []).reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);

          outputDiv.innerHTML = \`
            <h5>Dokumen Permintaan Pengapalan Barang Angkutan Laut</h5>
            <h6>SHIPPING INSTRUCTION<br>No. \${res_transaction_no}</h6>
            <div class="barcode-qr-container">
              <div><svg id="barcode"></svg></div>
              <div id="qrcode" class="mt-2"></div>
            </div>
            <p class="mt-3"><strong>Nama Customer:</strong> \${customerName}</p>
            <table class="table table-bordered table-sm"> 
              <tr><td class="fw-medium">Nama Pemilik/Pengirim Barang</td><td>PT. ARIVINDO TECH LESTARI</td></tr>
              <tr><td class="fw-medium">Alamat Perusahaan</td><td>Dusun 4, Desa Rejo Mulyo RT09, Kec. Tanjung Bintang, Tanjung Bintang, Kab.Lampung Selatan</td></tr>
            </table>
            <table class="table table-bordered table-sm mt-3">
              <tr><td class="fw-medium">Nama Pelayaran Agen</td><td>Rejomulyo</td></tr>
              <tr><td class="fw-medium">Alamat Kantor Pusat</td><td>Gedung Menara 165 Lt 4 , Jalan TB simatupang, Kav 1 Cilandak Timur, Pasar Minggu, Kota Adm Jakarta Selatan</td></tr>
              <tr><td class="fw-medium">Alamat Kantor Cabang</td><td>-</td></tr>
              <tr><td class="fw-medium">Nama Kapal</td><td>\${ship_via || '-'}</td></tr>
              <tr><td class="fw-medium">ETD/ETA</td><td>\${transaction_date ? new Date(transaction_date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }) : '-'} s/d [ETA Belum Tersedia]</td></tr>
              <tr><td class="fw-medium">Pelabuhan Muat</td><td>\${tagText}</td></tr>
            </table>
            <table class="table table-bordered table-sm mt-3">
              <thead class="table-primary">
                <tr><th>NO</th><th>JENIS BARANG</th><th>JUMLAH (Liter)</th></tr>
              </thead>
              <tbody>
                \${itemsHtml.length > 0 ? itemsHtml : '<tr><td colspan="3" class="text-center fst-italic text-muted">Tidak ada item transaksi.</td></tr>'}
                <tr><td colspan="2" class="fw-bold">JUMLAH</td><td class="fw-bold">\${totalQty}</td></tr>
              </tbody>
            </table>
            <p class="mt-4">Lampung, ...............................................</p>
            <p><strong>Pemilik/Pengirim Barang</strong><br>PT. ARIVINDO TECH LESTARI</p>
          \`;

          const barcodeElement = document.getElementById('barcode');
          if (barcodeElement) {
            try {
              JsBarcode(barcodeElement, res_transaction_no, {
                format: "CODE128", displayValue: true, fontSize: 16, margin: 10, width: 2, height: 80
              });
            } catch (barcodeError) {
              console.error("Error saat membuat barcode:", barcodeError, "untuk data:", res_transaction_no);
              barcodeElement.parentElement.innerHTML = "<p class='text-danger small mt-1'>Gagal membuat barcode.</p>";
            }
          }

          const qrcodeElement = document.getElementById('qrcode');
          if (qrcodeElement) {
            qrcodeElement.innerHTML = ''; 
            try {
              new QRCode(qrcodeElement, {
                text: \`No Transaksi: \${res_transaction_no}\nCustomer: \${customerName}\nTanggal: \${transaction_date ? new Date(transaction_date).toLocaleDateString('id-ID') : '-'}\`,
                width: 110, height: 110, correctLevel : QRCode.CorrectLevel.M
              });
            } catch (qrError) {
              console.error("Error saat membuat QR Code:", qrError);
              qrcodeElement.innerHTML = "<p class='text-danger small mt-1'>Gagal membuat QR code.</p>";
            }
          }
          outputDiv.style.display = 'block';
          closeBtn.classList.remove('d-none');
          exportBtn.classList.remove('d-none');
          showCustomAlert('Data berhasil dimuat dan SI dibuat.', 'success', 'Sukses');
        } else {
          showCustomAlert(result.message || 'Data tidak ditemukan atau terjadi kesalahan.', 'warning', 'Info Data');
          outputDiv.innerHTML = \`<div class="alert alert-warning">\${result.message || 'Data tidak ditemukan atau terjadi kesalahan.'}</div>\`;
          outputDiv.style.display = 'block';
          closeBtn.classList.remove('d-none');
          exportBtn.classList.add('d-none');
        }
    } catch (error) {
        console.error("Error saat submit form:", error);
        showCustomAlert(\`Terjadi kesalahan: \${error.message}\`, 'danger', 'Error Aplikasi');
        outputDiv.innerHTML = \`<div class="alert alert-danger">Terjadi kesalahan: \${error.message}</div>\`;
        outputDiv.style.display = 'block';
        closeBtn.classList.remove('d-none');
        exportBtn.classList.add('d-none');
    }
  });

  function closeResult() {
    outputDiv.style.display = 'none';
    outputDiv.innerHTML = '';
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');
    transactionNoInput.value = '';
    transactionNoInput.focus();
  }

  document.getElementById('exportPdfBtn').addEventListener('click', () => {
    const elementToExport = document.getElementById('result');
    if (!elementToExport || outputDiv.style.display === 'none' || !elementToExport.querySelector('h6')) { // Cek jika ada h6 (indikasi ada data)
        showCustomAlert('Tidak ada data untuk diexport ke PDF.', 'info');
        return;
    }

    const transactionNoElement = elementToExport.querySelector('h6');
    let fileName = \`shipping-instruction-\${Date.now()}.pdf\`;
    if (transactionNoElement && transactionNoElement.innerText.includes('No.')) {
        const transactionNoText = transactionNoElement.innerText.split('No.')[1]?.trim();
        if (transactionNoText) {
            const safeTransactionNo = transactionNoText.replace(/[^a-zA-Z0-9.-]/g, '_');
            fileName = \`SI_\${safeTransactionNo}.pdf\`;
        }
    }

    const originalTitle = document.title;
    document.title = fileName.replace('.pdf', '');
    elementToExport.classList.add('pdf-export'); // Untuk styling khusus PDF jika ada
    
    showCustomAlert('Mempersiapkan PDF...', 'info', 'Export PDF');

    const opt = {
      margin:       [10, 7, 10, 7], // mm [top, left, bottom, right]
      filename:     fileName,
      image:        { type: 'jpeg', quality: 0.96 },
      html2canvas:  {
        scale: 2.5, // Tingkatkan skala untuk kualitas lebih baik
        useCORS: true,
        logging: false, // Matikan logging html2canvas di console
        scrollY: -window.scrollY,
        windowWidth: elementToExport.scrollWidth,
        windowHeight: elementToExport.scrollHeight
      },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
      pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().from(elementToExport).set(opt).save().then(() => {
      elementToExport.classList.remove('pdf-export');
      document.title = originalTitle;
      showCustomAlert('PDF berhasil diexport!', 'success', 'Export Selesai');
    }).catch(err => {
      console.error("Error exporting PDF:", err);
      showCustomAlert(\`Gagal mengekspor PDF: \${err.message || 'Kesalahan tidak diketahui.'}\`, 'danger', 'Error Export');
      elementToExport.classList.remove('pdf-export');
      document.title = originalTitle;
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
