<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tracking Bungker - Barcode/QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    nav {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-form {
      max-width: 800px;
      margin: 2rem auto; /* Tambahkan margin atas dan bawah */
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background-color: #ffffff;
      position: relative;
      border: 1px solid #dee2e6;
    }
    .document h5 {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .document h6 {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .document .table td, .document .table th {
      vertical-align: middle;
    }
    #result {
      display: none;
      margin-top: 1rem;
    }
    /* .btn-close-custom tidak digunakan, bisa dihapus jika tidak ada elemennya */
    /* .ship-img tidak digunakan, bisa dihapus jika tidak ada elemennya */
    .form-section {
      position: relative;
      z-index: 1;
    }
    hr.custom-line {
      border-top: 1px solid #dee2e6; /* Sedikit ubah style hr */
      margin: 1.5rem 0; /* Sesuaikan margin */
    }
    .barcode-qr-container {
      display: flex;
      justify-content: center;
      align-items: center; /* Pusatkan vertikal juga */
      gap: 2rem;
      margin: 2rem 0;
    }
    /* Untuk memastikan PDF tidak terpotong */
    .document {
      page-break-inside: avoid;
    }
    .table {
      page-break-inside: avoid;
    }
    #qrcode img { /* Pastikan QR code terlihat jelas */
        margin: auto;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">Tracking Bungker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/">Beranda</a></li>
        <li class="nav-item"><a class="nav-link" href="/barcode-qr.html">Create SI</a></li>
        <li class="nav-item"><a class="nav-link" href="/update-status.html">Update Status</a></li>
        <li class="nav-item"><a class="nav-link text-danger fw-bold" href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container pb-5">
  <div class="card-form">
    <div class="form-section">
      <div class="text-center mb-3">
        <img src="/images/LOGO ATL_1024X1024.jpeg" alt="ATL Energy Logo" style="max-width: 160px;" onerror="this.style.display='none'; console.warn('Logo tidak ditemukan di /images/LOGO ATL_1024X1024.jpeg')">
      </div>
      <hr class="custom-line">
      <form id="trackerForm" class="d-flex gap-2 flex-column flex-md-row mb-3">
        <input type="text" id="transaction_no" class="form-control" placeholder="Masukkan No Transaksi" required />
        <button type="submit" class="btn btn-primary px-4">Create Shipping Instruction</button>
      </form>
      <div class="d-flex justify-content-end gap-2 mb-3"> <button id="exportPdfBtn" class="btn btn-success d-none"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
        <button class="btn btn-danger btn-sm d-none" id="closeResultBtn" onclick="closeResult()"><i class="fas fa-times me-1"></i>Tutup Data</button>
      </div>
      <div id="result" class="document">
        </div>
    </div>
  </div>
</div>

<script>
  // Pastikan Font Awesome sudah diload jika menggunakan ikon seperti <i class="fas fa-file-pdf"></i>
  // Jika belum, tambahkan link ke Font Awesome di <head>
  // <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  const form = document.getElementById('trackerForm');
  const outputDiv = document.getElementById('result');
  const closeBtn = document.getElementById('closeResultBtn');
  const exportBtn = document.getElementById('exportPdfBtn');
  const transactionNoInput = document.getElementById('transaction_no'); // Ambil input field

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const transaction_no = transactionNoInput.value.trim(); // Trim spasi

    if (!transaction_no) {
        alert('Nomor transaksi tidak boleh kosong.');
        outputDiv.innerHTML = `<div class="alert alert-warning">Nomor transaksi tidak boleh kosong.</div>`;
        outputDiv.style.display = 'block';
        closeBtn.classList.add('d-none'); // Sembunyikan tombol tutup jika input kosong
        exportBtn.classList.add('d-none'); // Sembunyikan tombol export jika input kosong
        return;
    }

    // Tampilkan loading sederhana (opsional)
    outputDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <p>Memuat data...</p></div>`;
    outputDiv.style.display = 'block';
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');


    try {
        const response = await fetch('/track', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transaction_no })
        });

        if (!response.ok) {
            // Coba parse error dari server jika ada
            let errorMessage = `Gagal mengambil data. Status: ${response.status}`;
            try {
                const errorResult = await response.json();
                errorMessage = errorResult.message || errorMessage;
            } catch (parseError) {
                // Biarkan errorMessage default jika parsing gagal
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();

        if (result.success && result.data) {
          const { transaction_no: res_transaction_no, transaction_date, ship_via, tags, person, transaction_lines_attributes, memo } = result.data;
          const tagText = (tags && tags.length > 0) ? tags.map(t => t.name || t).join(', ') : '-'; // Jika tags adalah array of objects
          const customerName = person?.display_name || person?.name || '-'; // Lebih banyak fallback untuk nama customer

          const itemsHtml = (transaction_lines_attributes || []).map((item, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${item.product?.name || item.name || item.description || '-'}</td>
              <td>${item.quantity ?? 0}</td>
            </tr>`).join('');
          const totalQty = (transaction_lines_attributes || []).reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);

          outputDiv.innerHTML = \`
            <h5>Dokumen Permintaan Pengapalan Barang Angkutan Laut</h5>
            <h6>SHIPPING INSTRUCTION<br>No. \${res_transaction_no}</h6>
            <div class="barcode-qr-container">
              <div><svg id="barcode"></svg></div>
              <div id="qrcode" class="mt-2"></div>
            </div>
            <p class="mt-3"><strong>Nama Customer:</strong> \${customerName}</p>
            <table class="table table-bordered table-sm"> <tr><td>Nama Pemilik/Pengirim Barang</td><td>PT. ARIVINDO TECH LESTARI</td></tr>
              <tr><td>Alamat Perusahaan</td><td>Dusun 4, Desa Rejo Mulyo RT09, Kec. Tanjung Bintang, Tanjung Bintang, Kab.Lampung Selatan</td></tr>
            </table>
            <table class="table table-bordered table-sm mt-3">
              <tr><td>Nama Pelayaran Agen</td><td>Rejomulyo</td></tr>
              <tr><td>Alamat Kantor Pusat</td><td>Gedung Menara 165 Lt 4 , Jalan TB simatupang, Kav 1 Cilandak Timur, Pasar Minggu, Kota Adm Jakarta Selatan</td></tr>
              <tr><td>Alamat Kantor Cabang</td><td>-</td></tr>
              <tr><td>Nama Kapal</td><td>\${ship_via || '-'}</td></tr>
              <tr><td>ETD/ETA</td><td>\${transaction_date ? new Date(transaction_date).toLocaleDateString('id-ID') : '-'} s/d [ETA Belum Tersedia]</td></tr>
              <tr><td>Pelabuhan Muat</td><td>\${tagText}</td></tr>
            </table>
            <table class="table table-bordered table-sm mt-3">
              <thead class="table-primary">
                <tr><th>NO</th><th>JENIS BARANG</th><th>JUMLAH (Liter)</th></tr>
              </thead>
              <tbody>
                \${itemsHtml.length > 0 ? itemsHtml : '<tr><td colspan="3" class="text-center">Tidak ada item.</td></tr>'}
                <tr><td colspan="2" class="fw-bold">JUMLAH</td><td class="fw-bold">\${totalQty}</td></tr>
              </tbody>
            </table>
            <p class="mt-4">Lampung, ...............................................</p>
            <p><strong>Pemilik/Pengirim Barang</strong><br>PT. ARIVINDO TECH LESTARI</p>
          \`;

          // Generate Barcode
          if (document.getElementById('barcode')) {
            JsBarcode("#barcode", res_transaction_no, {
              format: "CODE128",
              displayValue: true,
              fontSize: 16,
              margin: 10 // Tambahkan margin
            });
          }

          // Generate QR Code
          const qrcodeElement = document.getElementById('qrcode');
          if (qrcodeElement) {
            qrcodeElement.innerHTML = ''; // Bersihkan QR code sebelumnya
            new QRCode(qrcodeElement, {
              text: \`No Transaksi: \${res_transaction_no}\nCustomer: \${customerName}\`, // Info lebih di QR
              width: 120, // Sedikit lebih kecil agar pas
              height: 120,
              correctLevel : QRCode.CorrectLevel.H
            });
          }

          outputDiv.style.display = 'block';
          closeBtn.classList.remove('d-none');
          exportBtn.classList.remove('d-none');
        } else {
          // Jika success false dari server
          outputDiv.innerHTML = \`<div class="alert alert-warning">\${result.message || 'Data tidak ditemukan atau terjadi kesalahan.'}</div>\`;
          outputDiv.style.display = 'block';
          closeBtn.classList.remove('d-none'); // Tetap tampilkan tombol tutup
          exportBtn.classList.add('d-none');
        }
    } catch (error) {
        console.error("Error fetching track data:", error);
        outputDiv.innerHTML = \`<div class="alert alert-danger">Terjadi kesalahan saat mengambil data: \${error.message}</div>\`;
        outputDiv.style.display = 'block';
        closeBtn.classList.remove('d-none');
        exportBtn.classList.add('d-none');
    }
  });

  function closeResult() {
    outputDiv.style.display = 'none';
    outputDiv.innerHTML = ''; // Kosongkan hasil
    closeBtn.classList.add('d-none');
    exportBtn.classList.add('d-none');
    transactionNoInput.value = ''; // Kosongkan input field
    transactionNoInput.focus(); // Fokus kembali ke input field
  }

  document.getElementById('exportPdfBtn').addEventListener('click', () => {
    const elementToExport = document.getElementById('result');
    if (!elementToExport || outputDiv.style.display === 'none' || !elementToExport.innerHTML.trim()) {
        alert("Tidak ada data untuk diexport ke PDF.");
        return;
    }

    const transactionNoElement = elementToExport.querySelector('h6');
    let fileName = \`shipping-instruction-\${Date.now()}.pdf\`;
    if (transactionNoElement && transactionNoElement.innerText.includes('No.')) {
        const transactionNoText = transactionNoElement.innerText.split('No.')[1]?.trim();
        if (transactionNoText) {
            const safeTransactionNo = transactionNoText.replace(/[^a-zA-Z0-9.-]/g, '_');
            fileName = \`SI_\${safeTransactionNo}.pdf\`;
        }
    }

    // Tambahkan judul sementara untuk PDF
    const originalTitle = document.title;
    document.title = fileName.replace('.pdf', '');

    elementToExport.classList.add('pdf-export'); // Kelas untuk styling khusus PDF jika ada
    const opt = {
      margin:       [10, 8, 10, 8], // margin: [atas, kiri, bawah, kanan] dalam mm
      filename:     fileName,
      image:        { type: 'jpeg', quality: 0.95 },
      html2canvas:  {
        scale: 2, // Tingkatkan skala untuk kualitas lebih baik
        useCORS: true, // Jika ada gambar dari domain lain
        scrollY: -window.scrollY, // Atasi masalah scroll
        windowWidth: document.documentElement.offsetWidth,
        windowHeight: document.documentElement.offsetHeight
      },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
      pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } // Hindari pemotongan elemen
    };

    html2pdf().from(elementToExport).set(opt).save().then(() => {
      elementToExport.classList.remove('pdf-export');
      document.title = originalTitle; // Kembalikan judul asli
    }).catch(err => {
      console.error("Error exporting PDF:", err);
      alert("Gagal mengekspor PDF. Silakan coba lagi.");
      elementToExport.classList.remove('pdf-export');
      document.title = originalTitle;
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
